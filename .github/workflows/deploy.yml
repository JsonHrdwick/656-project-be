name: Deploy Spring Boot Gradle to EC2

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Run tests with Gradle
        run: ./gradlew test --no-daemon
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/
          retention-days: 30

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Build JAR using Gradle
      - name: Build JAR
        run: ./gradlew clean bootJar --no-daemon

      # Setup SSH
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # Copy systemd service file if it exists (optional - for better process management)
      - name: Copy systemd service file to EC2
        run: |
          if [ -f springboot-app.service ]; then
            scp -i ~/.ssh/id_rsa springboot-app.service ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/springboot-app.service
          fi

      # Deploy JAR to EC2
      - name: Deploy JAR to EC2
        run: |
          scp -i ~/.ssh/id_rsa build/libs/*.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/app.jar
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            # Create app directory if it doesn't exist
            mkdir -p ~/app
            
            # Create or update environment file (systemd compatible format)
            # Directly write values from GitHub secrets to .env file
            echo "PORT=${{ secrets.PORT }}" > ~/app/.env
            echo "PGHOST=${{ secrets.PGHOST }}" >> ~/app/.env
            echo "PGPORT=${{ secrets.PGPORT }}" >> ~/app/.env
            echo "PGDATABASE=${{ secrets.PGDATABASE }}" >> ~/app/.env
            echo "PGUSER=${{ secrets.PGUSER }}" >> ~/app/.env
            echo "PGPASSWORD=${{ secrets.PGPASSWORD }}" >> ~/app/.env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ~/app/.env
            echo "JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}" >> ~/app/.env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> ~/app/.env
            echo "OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}" >> ~/app/.env
            echo "OPENAI_MAX_TOKENS=${{ secrets.OPENAI_MAX_TOKENS }}" >> ~/app/.env
            echo "DOCUMENT_STORAGE_PATH=${{ secrets.DOCUMENT_STORAGE_PATH }}" >> ~/app/.env
            
            # Set defaults for empty values - handle both empty secrets and missing values
            # Use awk for more reliable processing
            awk -F= '
              /^PORT=$|^PORT[[:space:]]*$/ { $0="PORT=8080" }
              /^PGPORT=$|^PGPORT[[:space:]]*$/ { $0="PGPORT=5432" }
              /^PGUSER=$|^PGUSER[[:space:]]*$/ { $0="PGUSER=postgres" }
              /^JWT_EXPIRATION=$|^JWT_EXPIRATION[[:space:]]*$/ { $0="JWT_EXPIRATION=86400000" }
              /^OPENAI_MODEL=$|^OPENAI_MODEL[[:space:]]*$/ { $0="OPENAI_MODEL=gpt-3.5-turbo" }
              /^OPENAI_MAX_TOKENS=$|^OPENAI_MAX_TOKENS[[:space:]]*$/ { $0="OPENAI_MAX_TOKENS=1000" }
              { print }
            ' ~/app/.env > ~/app/.env.tmp && mv ~/app/.env.tmp ~/app/.env
            
            # Handle DOCUMENT_STORAGE_PATH with variable expansion
            CURRENT_HOME=$(eval echo ~$(whoami))
            if grep -q '^DOCUMENT_STORAGE_PATH=$' ~/app/.env || ! grep -q '^DOCUMENT_STORAGE_PATH=' ~/app/.env; then
              sed -i "s|^DOCUMENT_STORAGE_PATH=.*|DOCUMENT_STORAGE_PATH=$CURRENT_HOME/app/uploads|" ~/app/.env
              grep -q '^DOCUMENT_STORAGE_PATH=' ~/app/.env || echo "DOCUMENT_STORAGE_PATH=$CURRENT_HOME/app/uploads" >> ~/app/.env
            fi
            
            # Ensure PORT exists (in case file was empty)
            grep -q '^PORT=' ~/app/.env || echo "PORT=8080" >> ~/app/.env
            
            chmod 600 ~/app/.env
            
            # Verify .env file contents (for debugging)
            if [ -f ~/app/.env ]; then
              echo "Environment file created. Variables:"
              PGHOST_VAL=$(grep '^PGHOST=' ~/app/.env | cut -d'=' -f2-)
              PGPORT_VAL=$(grep '^PGPORT=' ~/app/.env | cut -d'=' -f2-)
              PGDATABASE_VAL=$(grep '^PGDATABASE=' ~/app/.env | cut -d'=' -f2-)
              echo "- PGHOST: ${PGHOST_VAL:+set (${#PGHOST_VAL} chars)}${PGHOST_VAL:-not set}"
              echo "- PGPORT: ${PGPORT_VAL:-not set, using default}"
              echo "- PGDATABASE: ${PGDATABASE_VAL:+set}${PGDATABASE_VAL:-not set}"
              echo "- Total variables: $(wc -l < ~/app/.env)"
              echo "- File size: $(wc -c < ~/app/.env) bytes"
            else
              echo "ERROR: .env file was not created!"
              exit 1
            fi
            
            # Stop previous app if running (using systemd if service exists)
            # First disable the service to prevent it from restarting
            if systemctl is-enabled springboot-app.service 2>/dev/null; then
              echo "Disabling systemd service to prevent auto-restart loops..."
              sudo systemctl stop springboot-app.service 2>/dev/null || true
              sudo systemctl disable springboot-app.service 2>/dev/null || true
            fi
            if pgrep -f "app.jar" > /dev/null; then
              echo "Stopping existing app.jar process..."
              pkill -f "app.jar"
            fi
            
            # Wait a moment for process to stop
            sleep 2
            
            # Install/update systemd service if file exists
            # Always reinstall to ensure latest version without postgresql dependency
            if [ -f ~/springboot-app.service ]; then
              # Update user and paths in service file based on actual user
              CURRENT_USER=$(whoami)
              CURRENT_HOME=$(eval echo ~$CURRENT_USER)
              APP_DIR="$CURRENT_HOME/app"
              
              # Find Java executable
              JAVA_PATH=$(which java || echo "/usr/bin/java")
              if [ ! -f "$JAVA_PATH" ]; then
                JAVA_PATH="/usr/lib/jvm/java-17-amazon-corretto/bin/java"
                [ ! -f "$JAVA_PATH" ] && JAVA_PATH="/usr/lib/jvm/java-17-openjdk/bin/java"
                [ ! -f "$JAVA_PATH" ] && JAVA_PATH="java"
              fi
              
              # Create service file with correct paths
              sed "s|/home/ec2-user|$CURRENT_HOME|g" ~/springboot-app.service > /tmp/springboot-app.service
              sed -i "s|/home/ubuntu|$CURRENT_HOME|g" /tmp/springboot-app.service
              sed -i "s|/usr/bin/java|$JAVA_PATH|g" /tmp/springboot-app.service
              sed -i "s|WorkingDirectory=.*|WorkingDirectory=$APP_DIR|" /tmp/springboot-app.service
              sed -i "s|EnvironmentFile=.*|EnvironmentFile=$APP_DIR/.env|" /tmp/springboot-app.service
              sed -i "s|-jar .*app.jar|-jar $APP_DIR/app.jar|" /tmp/springboot-app.service
              
              # Ensure no postgresql dependencies remain
              sed -i '/Requires=postgresql/d' /tmp/springboot-app.service
              sed -i '/After=.*postgresql/d' /tmp/springboot-app.service
              
              # Verify paths exist before installing service
              if [ ! -f "$APP_DIR/.env" ]; then
                echo "WARNING: .env file not found at $APP_DIR/.env, creating it..."
                touch "$APP_DIR/.env"
              fi
              if [ ! -f "$APP_DIR/app.jar" ]; then
                echo "ERROR: app.jar not found at $APP_DIR/app.jar"
                echo "Cannot install systemd service without app.jar"
              else
                # Copy and enable service
                sudo cp /tmp/springboot-app.service /etc/systemd/system/springboot-app.service
                sudo chmod 644 /etc/systemd/system/springboot-app.service
                sudo systemctl daemon-reload
                sudo systemctl enable springboot-app.service
                echo "Systemd service installed/updated for user: $CURRENT_USER"
                echo "  Java path: $JAVA_PATH"
                echo "  App directory: $APP_DIR"
                echo "  Environment file: $APP_DIR/.env"
                echo "  JAR file: $APP_DIR/app.jar"
              fi
            fi
            
            # Start app using systemd if service exists, otherwise use nohup
            if [ -f /etc/systemd/system/springboot-app.service ]; then
              # Verify critical paths exist
              APP_DIR=$(eval echo ~$(whoami))/app
              if [ ! -f "$APP_DIR/.env" ]; then
                echo "ERROR: .env file missing at $APP_DIR/.env"
                echo "Cannot start systemd service without .env file"
                echo "Falling back to nohup..."
                set -a
                [ -f ~/app/.env ] && source ~/app/.env || true
                set +a
                nohup java -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar ~/app/app.jar > ~/app/app.log 2>&1 &
                echo "Started using nohup (systemd service skipped due to missing .env)"
              elif [ ! -f "$APP_DIR/app.jar" ]; then
                echo "ERROR: app.jar missing at $APP_DIR/app.jar"
                echo "Cannot start systemd service without app.jar"
                echo "Falling back to nohup..."
                set -a
                source ~/app/.env
                set +a
                nohup java -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar ~/app/app.jar > ~/app/app.log 2>&1 &
                echo "Started using nohup (systemd service skipped due to missing app.jar)"
              else
                # Verify .env file is readable by systemd (must not have spaces around =)
                # Clean up any potential formatting issues
                sed -i 's/ *= */=/' ~/app/.env
                sed -i '/^$/d' ~/app/.env
                
                # Verify .env file has required variables
                if ! grep -q '^PGHOST=' ~/app/.env; then
                  echo "WARNING: PGHOST not set in .env file"
                fi
                if ! grep -q '^PGDATABASE=' ~/app/.env; then
                  echo "WARNING: PGDATABASE not set in .env file"
                fi
                
                echo "Starting systemd service..."
                sudo systemctl daemon-reload
                sudo systemctl stop springboot-app.service 2>/dev/null || true
                sleep 1
                sudo systemctl start springboot-app.service
                if [ $? -eq 0 ]; then
                  echo "Started using systemd service"
                  sleep 3
                  sudo systemctl status springboot-app.service --no-pager -l || true
                else
                  echo "Failed to start systemd service, checking logs..."
                  sudo journalctl -u springboot-app -n 30 --no-pager || true
                  echo "Falling back to nohup..."
                  set -a
                  source ~/app/.env
                  set +a
                  nohup java -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar ~/app/app.jar > ~/app/app.log 2>&1 &
                  echo "Started using nohup"
                fi
              fi
            else
              # Load environment variables and start app in background
              set -a
              source ~/app/.env
              set +a
              nohup java -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar ~/app/app.jar > ~/app/app.log 2>&1 &
              echo "Started using nohup"
            fi
            
            # Show status
            echo "Deployment complete. Checking status..."
            sleep 3
            if pgrep -f "app.jar" > /dev/null || systemctl is-active --quiet springboot-app.service 2>/dev/null; then
              echo "Application is running"
              if systemctl is-active --quiet springboot-app.service 2>/dev/null; then
                echo "View logs with: sudo journalctl -u springboot-app -f"
              else
                echo "View logs with: tail -f ~/app/app.log"
              fi
            else
              echo "WARNING: Application may not have started. Check logs:"
              if [ -f /etc/systemd/system/springboot-app.service ]; then
                echo "  sudo journalctl -u springboot-app -n 50"
              else
                echo "  tail -f ~/app/app.log"
              fi
            fi
          EOF
